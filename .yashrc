# enable command line prediction
set --le-predict
bindkey --vi-insert '\^F' end-of-line
bindkey --vi-insert '\^O' clear-candidates

# normally yash is more POSIX-compliant than /bin/sh :-)
sh() { yash --posix "$@"; }
yash() { command yash "$@"; }

# ensure job control works as expected
case $- in (*m*)
  trap - TSTP TTIN TTOU
esac

# variables needed for command history
HISTFILE=~/.yash_history HISTSIZE=5000

# define prompt
if [ -n "${SSH_CONNECTION-}" ]; then
  _hc='\fy.'     # yellow hostname for SSH remote
else
  _hc='\fg.'     # green hostname for local
fi
if [ "$(id -u)" -eq 0 ]; then
  _uc='\fr.'     # red username for root
else
  _uc=$_hc _hc=  # same username color as hostname for non-root user
fi
git_branch() {
    branch=$(git -C "$PWD" rev-parse --abbrev-ref HEAD 2>/dev/null)
    if [ -n "$branch" ]; then
        echo " ($branch)"
    fi
}
YASH_PS1=$_uc'$(whoami)'$_hc'@$(uname -n)\fd. '\
'$(echo "$PWD" | sed "s/\/home\/rai/~/")'\
'\fc.$(git_branch)\fd. $ '
unset _hc _uc

# enable fasd integration
eval "$(fasd --init posix-hook posix-alias)"
# fasd only adds to $PS1, but yash uses $YASH_PS1 when not in posix mode
YASH_PS1='$(_fasd_ps1_func)'$YASH_PS1

if [ "$TERM" == "foot" ]; then
    # insert special escape codes for foot terminal
    foot_escs() {
        # update window title
        title=$(echo $PWD | sed 's/\/home\/rai/~/')
        printf "\033];%s\a" "$title" >&2
        # jump between shell prompts
        printf "%b" "\e]7;file://$(uname -n)${PWD}\e\\"
        # open new terminals in PWD
        printf '%b' '\e]133;A\e\\'
    }
    PROMPT_COMMAND=foot_escs
fi

fbuild() {
    # Avoid accidentally freezing system
    if [ $(uname -n) = "uraya" ] && [ -n "$(pgrep clangd)" ]; then
        echo "Close editor before compiling"
        return
    fi
    mode="Debug"
    if [ ! -z "$1" ]; then
        mode="$1"
    fi

    if [ "$mode" = "compdb" ]; then
        fastbuild/linux/fbuild -config fastbuild/fbuild.bff GCC-Debugx64-factorio-run GCC-Debugx64-factorio-test -compdb
        return
    fi

    target="run"
    if [ ! -z "$2" ]; then
        target="$2"
    fi

    threads=$(grep -c vendor_id /proc/cpuinfo)
    threads=$(($threads - 2))

    fastbuild/linux/fbuild -config fastbuild/fbuild.bff -j$threads GCC-${mode}x64-factorio-${target}
}

# aliases
alias dmenu="fuzzel -d"
alias n=nnn
alias k="kak"
alias sk="sudoedit"
alias dlg="lazygit --work-tree $HOME --git-dir $HOME/.dotfiles"
alias dgit="git --git-dir=$HOME/.dotfiles/ --work-tree=$HOME"
alias lg=lazygit
alias t="todoist-cli --color"
alias ipconfig="nmcli dev show wlan0 | grep IP4"
alias f=/home/rai/dev/factorio/1.1/bin/x64/factorio
alias fh=/home/rai/dev/factorio/headless/bin/x64/factorio
alias fs=factorio-test-server
alias fj=factorio-japanese
alias fdb=/home/rai/dev/projects/wube/Factorio-1.1/bin/Debugx64GCC/factorio-run
alias fr=/home/rai/dev/projects/wube/Factorio-1.1/bin/Releasex64GCC/factorio-run
alias ffr=/home/rai/dev/projects/wube/Factorio-1.1/bin/FinalReleasex64GCC/factorio-run
alias fde=/home/rai/dev/projects/wube/Factorio-1.2/bin/Debugx64GCC/factorio-run
alias fre=/home/rai/dev/projects/wube/Factorio-1.2/bin/Releasex64GCC/factorio-run
alias ffre=/home/rai/dev/projects/wube/Factorio-1.2/bin/FinalReleasex64GCC/factorio-run

# PC-specific configuration
file=~/.yashrc_$(uname -n)
[[ -f $file ]] && . $file

# vim: ft=sh

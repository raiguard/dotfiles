#!/bin/sh

# factorio-fork copies the Factorio config file and changes the write directory
# to a temporary folder. The write directory receives symlinked mods, saves,
# scenarios, and blueprint-storage.dat files, and a unique username.

if [ -z "$FACTORIO" ]; then
    echo "FACTORIO environment variable is not defined"
    exit 1
fi

if [ "$1" == "-c" ]; then
    server="--mp-connect localhost:34197"
    shift
elif [ "$1" == "-h" ]; then
    server="--start-server-load-scenario base/freeplay"
    shift
fi

if [ "$1" == "-l" ]; then
    lang="$2"
    shift 2
fi

basedir=$(dirname "$FACTORIO")/../..
write=$(mktemp -d /tmp/factorio-fork.XXX)
awk -v lang="locale=$lang" -v writedata="write-data=$write" '
    { flag = 1 }
    /write-data/ { flag = 0; print writedata }
    /locale/ { flag = 0; print lang }
    /check-updates/ { flag = 0; print "check-updates=false" }
    flag { print }
' $basedir/config/config.ini > $write/config.ini

ln -s $basedir/atlas-cache.dat $write/atlas-cache.dat
ln -s $basedir/crop-cache.dat $write/crop-cache.dat

ln -s $basedir/mods $write/mods
ln -s $basedir/saves $write/saves
ln -s $basedir/scenarios $write/scenarios

ln -s $basedir/server-adminlist.json $write/server-adminlist.json
ln -s $basedir/server-settings.json $write/server-settings.json

jq \
    --arg username $(echo "$write" | sed "s~/tmp/factorio-fork\.~~") \
    '.["service-username"] = $username | .["service-token"] = ""' \
    $basedir/player-data.json > $write/player-data.json

echo "Write directory: $write"
$FACTORIO --config "$write/config.ini" $server "$@"
rm -rf $write

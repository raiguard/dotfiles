#!/bin/sh

if [ -f "/usr/local/bin/kak" ]; then
    kak="/usr/local/bin/kak"
else
    kak="/usr/bin/kak"
fi

# Only do stuff if invoked with 'kak <filename>'
case "$1" in
    -*)
        $kak $@
        exit
    ;;
esac

basedir=$(git rev-parse --show-toplevel 2> /dev/null)
if [ -n "$basedir" ]; then
    # Set session name
    session=$(basename "$basedir" | sed "s/\./-/g")
    # Change filename to absolute path
    # This only works with the first one, but that's fine
    set -- $(realpath $1)
    # Change to project root dir
    cd $basedir
fi

sessions=$($kak -l)
if $(echo "$sessions" | grep -q "(dead)"); then
    echo "Clearing dead sessions"
    $kak -clear
    sessions=$($kak -l)
fi

# TODO: Convenient way to connect to last session?
if [ -z "$session" ]; then
    $kak $@
    exit
fi

if $(echo "$sessions" | grep -q "\b$session\b"); then
    $kak -c $session $@
else
    $kak -s $session $@
fi

#!/bin/sh

if [ ! -e "fastbuild/linux/fbuild" ]; then
  echo "Not in a Factorio source directory"
  exit
fi

fbuild="fastbuild/linux/fbuild -config fastbuild/fbuild.bff"

if [ "$1" = "compdb" ]; then
  $fbuild GCC-Debugx64-factorio-run GCC-Debugx64-factorio-test -compdb
  exit
fi

mode="debug"
type="run"
if [ -n "$1" ]; then
  case $1 in
    test) type="test" ;;
    *) mode=$1 ;;
  esac
fi

if [ -n "$2" ]; then
  type="$2"
fi

threads=$FACTORIO_COMPILE_THREADS
if [ -z "$threads" ]; then
  threads=$(grep -c vendor_id /proc/cpuinfo)
  threads=$(($threads - 2))
fi

CC="/usr/bin/gcc-12" CXX="/usr/bin/g++-12" $fbuild -j$threads GCC-${mode}x64-factorio-${type}

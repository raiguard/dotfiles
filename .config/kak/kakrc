# ========================================
# PLUG.KAK

decl -hidden str plugkakdir "%val{config}/plugins/plug.kak"
decl -hidden str plugkak "%opt{plugkakdir}/rc/plug.kak"
try %{
    source "%opt{plugkak}"
} catch %sh{
    if [ ! -d "$kak_opt_plugkakdir" ]; then
        git clone https://github.com/robertmeta/plug.kak.git "$kak_opt_plugkakdir"
        echo "source '%opt{plugkak}"
    fi
}
plug "andreyorst/plug.kak" noload

# ========================================
# PLUGINS

# kakoune.cr (coderunner)
try %sh{
    kcr init kakoune
}

plug "alexherbo2/auto-pairs.kak" %{
    enable-auto-pairs
}
plug "alexherbo2/move-line.kak" %{
    require-module move-line
}
plug "alexherbo2/select.kak"
# plug "alexherbo2/search-highlighter.kak" %{
#     require-module search-highlighter
#     search-highlighter-enable
#     face global Search "default,rgb:%opt{subbg}"
# }
plug "andreyorst/smarttab.kak"
plug "crizan/kak-rainbower" %{
    set global rainbow_mode 0
    set global rainbow_check_templates Y
    # Dark theme:
    set global rainbow_colors "rgb:ffd700" "rgb:da70d6" "rgb:87cefa"
    # Light theme:
    # set global rainbow_colors "rgb:daa520" "rgb:9932cc" "rgb:00bfff"
}
plug "Crote/kakoune-ranger"
plug "delapouite/kakoune-buffers" %{
    alias global bo buffer-only
}
plug "delapouite/kakoune-mirror" %{
    map global normal "'" ": enter-user-mode -lock mirror<ret>"
    # Use a non-default register to avoid conflicting with phantom.kak
    # map global mirror d '"pZ<a-S><a-d>"pz<a-:>H' -docstring 'delete'
}
plug "delapouite/kakoune-npm"
plug "delapouite/kakoune-palette"
plug "delapouite/kakoune-text-objects"
plug "dgmulf/local-kakrc" config %{ set global source_local_kakrc true }
plug "eburghar/kakpipe" do %{
    cargo install --force --path . --root ~/.local
} config %{
    require-module kakpipe
}
plug "kak-lsp/kak-lsp" do %{ cargo install --locked --force --path . } config %{
    map global user "l" ": enter-user-mode lsp<ret>" -docstring "lsp..."

    set global lsp_diagnostic_line_error_sign '✕'
    # Workaround for the lack of a proper LineFlagWarnings face
    set global lsp_diagnostic_line_warning_sign '{LineFlagWarnings}!'

    set global lsp_hover_anchor true
    set global lsp_hover_max_lines 10

    lsp-auto-hover-insert-mode-enable

    def lsp-restart -docstring 'restart lsp server' %{ lsp-stop; lsp-start }

    def -hidden lsp-init -docstring "enable lsp and set up generic hooks" %{
        echo -debug "Enabling LSP for filetype %opt{filetype}"
        lsp-enable-window

        set window lsp_auto_highlight_references true

        hook window ModeChange (push|pop):.*:insert %{
            lsp-inline-diagnostics-disable window
        }
        hook window ModeChange (push|pop):insert:.* %{
            lsp-inline-diagnostics-enable window
        }

        # Function signature help in status bar
        lsp-auto-signature-help-enable

        # Semantic tokens
        hook window -group semantic-tokens BufReload .* lsp-semantic-tokens
        hook window -group semantic-tokens NormalIdle .* lsp-semantic-tokens
        hook window -group semantic-tokens InsertIdle .* lsp-semantic-tokens
        hook -once -always window WinSetOption filetype=.* %{
            rmhooks window semantic-tokens
        }
    }

    hook global KakEnd .* lsp-exit
}
plug "lePerdu/kakboard"
plug "occivink/kakoune-find"
plug "occivink/kakoune-buffer-switcher"
plug "occivink/kakoune-sort-selections"
plug "occivink/kakoune-vertical-selection"
plug "raiguard/one.kak" theme %{
    face global BufferSwitcherCurrent green
}
plug "raiguard/phantom.kak" %{
    require-module phantom
    phantom-enable
    phantom-add-alternate-mappings
}

plug "https://gitlab.com/Screwtapello/kakoune-state-save" %{
    hook global KakBegin .* %{
        # Defaults
        state-save-reg-load colon
        state-save-reg-load pipe
        state-save-reg-load slash
        state-save-reg-load caret

        # Macros
        state-save-reg-load q
        state-save-reg-load w
        state-save-reg-load e
        state-save-reg-load r
        # Generic
        state-save-reg-load a
        state-save-reg-load s
        state-save-reg-load d
        state-save-reg-load f
        # Marks
        state-save-reg-load z
        state-save-reg-load x
        state-save-reg-load c
        state-save-reg-load v
        # Plugins
        state-save-reg-load u
        state-save-reg-load i
        state-save-reg-load o
        state-save-reg-load p
    }

    hook global KakEnd .* %{
        # Defaults
        state-save-reg-save colon
        state-save-reg-save pipe
        state-save-reg-save slash
        state-save-reg-save caret

        # Macros
        state-save-reg-save q
        state-save-reg-save w
        state-save-reg-save e
        state-save-reg-save r
        # Generic
        state-save-reg-save a
        state-save-reg-save s
        state-save-reg-save d
        state-save-reg-save f
        # Marks
        state-save-reg-save z
        state-save-reg-save x
        state-save-reg-save c
        state-save-reg-save v
        # Plugins
        state-save-reg-save u
        state-save-reg-save i
        state-save-reg-save o
        state-save-reg-save p
    }
}

# ========================================
# SCRIPTS
# Sourced from autoload directory, gated behind modules

def plug-autoload -params 1..2 -docstring "req <name> <commands>" %{
    require-module "%arg{1}"
    try %{ evaluate-commands "%arg{2}" } catch %{}
}

plug-autoload fandt

plug-autoload "git-branch"

plug-autoload todo %{
    todo-enable
    todo-add-mapping
}

source "~/dev/projects/personal/vinegar.kak/vinegar.kak"
require-module vinegar

# ========================================
# GENERAL SETTINGS

# Color scheme
colorscheme one-darker
# source "~/dev/projects/personal/one.kak/one-darker.kak"

# Highlighters
addhl global/ number-lines -relative -hlcursor -separator " ▏ " -min-digits 4
addhl global/ show-matching
# addhl global/ show-whitespaces -tab "▏" -lf " " -nbsp "⋅" -spc " "
addhl global/trailing-whitespaces regex "(\h+)$" "1:default,rgba:%opt{darkred}%opt{selectionalpha}"

# RIP clippy and titles
set global ui_options terminal_assistant=off terminal_set_title=false

# Keep cursor away from the edges
set global scrolloff 5,5

# Auto-reload please!
set global autoreload yes

# Use ripgrep instead of grep
set global grepcmd 'rg -Hn --no-heading --trim'

# Don't show info boxes by default
set global autoinfo ""

# ========================================
# EXTERNAL SETTINGS

def load -params 1 %{
    source "%val{config}/%arg{1}.kak"
}

load "commands"
load "modes"
load "hooks"
load "keybindings"

# ========================================
# TEMPORARY

map global normal <c-i> <tab>

# FIXME: This can't go in the autoload file because that file loads before the included kak file
hook global WinSetOption filetype=rust %{
    rmhl window/rust
}

# source "~/dev/projects/personal/one.kak/one-darker.kak"
